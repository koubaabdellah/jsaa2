!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("wafer-module",[],t):"object"==typeof exports?exports["wafer-module"]=t():(e.wafer=e.wafer||{},e.wafer.wafers=e.wafer.wafers||{},e.wafer.wafers["wafer-module"]=t())}("undefined"!=typeof self?self:this,function(){return function(e){function t(r){if(a[r])return a[r].exports;var n=a[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var a={};return t.m=e,t.c=a,t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="https://s.yimg.com/aaq/wf/",t(t.s="./src/entry.js")}({"./src/base.js":function(e,t,a){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},l=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),s=function e(t,a,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,a);if(void 0===n){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,a,r)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(r)},d=[],c=window.wafer,u=c.base,f=c.constants,m=c.utils,g=c.WaferBaseClass,v=m.convertNodeListToArray,p=m.findAncestor,h=m.getConfigFromJSONScriptNode,y=m.getTemplateContent,_=m.setTimeout,E=m.throttle,b=f.ATTR_PREFIX,w=["handleAdd","handleDrag","handleDragEnd","handleDragEnter","handleDragIndicatorFocusIn","handleDragLeave","handleDragOver","handleDragStart","handleDrop","handleMouseEnter","handleMouseleave","handleMoveDown","handleMoveToColumn","handleMoveUp","handleRemove"],D="wafer-module-drag-indicator",M=document.body,A=function(e){function t(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=a.selector,l=a.successClass;r(this,t);var s=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,{selector:o},{STATE_ATTRS:d})),c=e.getAttribute(b+"module-id"),f=e.getAttribute(b+"module-remove-delay")||"1000",m=e.getAttribute(b+"module-drag-image-elem"),g=e.getAttribute(b+"module-remove-self-on-delete"),v="true"===e.getAttribute("draggable"),p=h(e.getElementsByClassName("wafer-module-config")[0]),y=e.getElementsByClassName(D)[0],M=void 0;if(m&&(M=e.getElementsByClassName(m)[0]),p.id&&e.classList.add("wafer-module-with-config"),w.forEach(function(e){s[e]=s[e].bind(s)}),s._util=i({},s._util,{config:p,contextMenuActiveIndex:0,contextMenuButtons:null,delay:f,dragElement:y,dragImageElem:M,elem:e,id:c,isDraggable:v,removeSelfOnDelete:null===g||void 0===g?1:Number(g),successClass:l}),s._state=s._state||{},v){var A=e.getAttribute(b+"module-drag-mouseenter-timeout")||100;s.addEventListeners(),s._util.dragMouseEnterTimeout=A,s._state=i({},s._state,{dragElem:null,dragProxy:null,focusDragElem:null,focusMenuElem:null,hoverTimeout:null,scrollStop:!0})}return e.classList.add(l),s.handleDragOver=E(s.handleDragOver,100),_(function(){s.addInstanceToIdMap(s),u.emitWaferEvent("module:added",{elem:e,meta:{id:c}})},s,0),s}return o(t,e),l(t,[{key:"removeDragDropOverCueFromAll",value:function(){var e=this._state.dragProxy;if(e){var t=e.parentNode;t&&t.removeChild(e)}v(document.getElementsByClassName("wafer-module-drop-over")).forEach(function(e){e.classList.remove("wafer-module-drop-over")})}},{key:"focus",value:function(){var e=this._util.dragElement;e&&_(function(){e.focus()},50,this)}},{key:"destroy",value:function(){var e,a=this._util.elem;if(a){var r=this._util,n=r.id,o=r.isDraggable;u.emitWaferEvent("module:destroyed",{elem:a,meta:{id:n}}),o&&this.removeEventListeners();for(var i=arguments.length,l=Array(i),d=0;d<i;d++)l[d]=arguments[d];(e=s(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this)).call.apply(e,[this].concat(l))}}},{key:"_closeContextMenu",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=t.clearDragElem,r=void 0===a||a;_(function(){var t=e._state.focusMenuElem,a=e._util.elem;a&&a.classList.remove("wafer-module-context-menu-open"),t&&t.parentNode.removeChild(t),e._state.focusMenuElem=null,r&&(e._state.focusDragElem=null),e._state.contextMenuButtons=null},5,this)}},{key:"_pageScroll",value:function(e){var t=this,a=window.scrollY;window.scrollTo({top:a+e}),this._state.scrollStop||_(function(){t._pageScroll(e)},20,this)}},{key:"handleRemove",value:function(){var e=this,t=this._util,a=t.elem,r=t.delay,n=t.removeSelfOnDelete;a.classList.add("wafer-module-delete-in-progress"),_(function(){n&&(u.destroy(a),e.destroy(),a.parentNode.removeChild(a)),a.classList.remove("wafer-module-delete-in-progress")},r,this),this.didRemove(a)}},{key:"handleDrag",value:function(e){e.stopPropagation();var t=this._util.elem;this._state.scrollStop=!0,t.classList.add("wafer-module-drag-in-progress"),M.classList.add("wafer-module-drag-in-progress"),this.setDragElem(e.currentTarget),e.clientY<150&&(this._state.scrollStop=!1,this._pageScroll(-1))}},{key:"handleDragEnter",value:function(e){var t=e.currentTarget;this.getDragElem()!==t&&(this.removeDragDropOverCueFromAll(),t.classList.add("wafer-module-drop-over"))}},{key:"handleDragLeave",value:function(e){var t=e.clientX,a=e.clientY,r=e.currentTarget,n=r.parentNode.getBoundingClientRect();if(a<n.top||a>=n.bottom||t<n.left||t>=n.right){if(this.getDragElem()===r)return;r.classList.remove("wafer-module-drop-over")}}},{key:"handleDragEnd",value:function(e){var t=this._util.elem;this._state.scrollStop=!0,t.classList.remove("wafer-module-drag-in-progress"),M.classList.remove("wafer-module-drag-in-progress"),this.removeDragDropOverCueFromAll()}},{key:"handleDragOver",value:function(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}},{key:"handleDragStart",value:function(e){var t=this._util,a=t.dragImageElem,r=t.elem;if(e.dataTransfer.effectAllowed="move",a){var n=document.createElement("div");n.classList.add("wafer-module-drag-proxy"),n.appendChild(a.cloneNode(!0)),document.body.appendChild(n),n.style.width=r.offsetWidth+"px",e.dataTransfer.setDragImage(n,e.offsetX,n.offsetHeight/2),this._state.dragProxy=n}}},{key:"handleAdd",value:function(e){this._closeContextMenu(),this.handleAdd()}},{key:"handleMoveUp",value:function(e){this._closeContextMenu({clearDragElem:!1}),this._handleMoveUp(e)}},{key:"handleMoveDown",value:function(e){this._closeContextMenu({clearDragElem:!1}),this._handleMoveDown(e)}},{key:"handleMoveToColumn",value:function(e){this._closeContextMenu({clearDragElem:!1}),this._handleMoveToColumn(e)}},{key:"handleMouseEnter",value:function(){if(this._util.isDraggable){var e=this._util,t=e.elem,a=e.dragMouseEnterTimeout;this._state.hoverTimeout=_(function(){t.classList.add("wafer-module-drag-hover-enter")},a,this)}}},{key:"handleMouseleave",value:function(){var e=this._util,t=e.isDraggable,a=e.isDropOnly;if(t&&!a){var r=this._util.elem;clearTimeout(this._state.hoverTimeout,this),r.classList.remove("wafer-module-drag-hover-enter")}}},{key:"handleDragIndicatorFocusIn",value:function(e){this._state.focusDragElem=e.target}},{key:"handleKeyboardDown",value:function(e){var t=this._state.focusDragElem;if(t){var a=e.keyCode,r=e.target,n=r.classList,o=void 0;if(32===a&&n&&n.contains(D)){e.preventDefault();var i=p(this._util.elem,"wafer-module-drop-target");if(i){var l=y(i.getElementsByClassName("wafer-module-drag-context-menu")[0]);if(l){var s=this._util.elem,d=document.createElement("div");d.classList.add("wafer-module-drag-options-context-menu"),this._state.focusMenuElem=d,d.innerHTML=l;t.parentNode.appendChild(d),s.classList.add("wafer-module-context-menu-open");var c=this._state.contextMenuButtons=d.getElementsByTagName("button");this._state.contextMenuActiveIndex=0,o=c[this._state.contextMenuActiveIndex],o&&_(function(){o.focus()},100,this)}}}else if(!this._state.contextMenuButtons)return;var u=this._state.contextMenuActiveIndex;38===a?(e.preventDefault(),0===u?this._state.contextMenuActiveIndex=this._state.contextMenuButtons.length-1:--this._state.contextMenuActiveIndex,o=this._state.contextMenuButtons[this._state.contextMenuActiveIndex]):40===a&&(e.preventDefault(),u>=this._state.contextMenuButtons.length-1?this._state.contextMenuActiveIndex=0:++this._state.contextMenuActiveIndex,o=this._state.contextMenuButtons[this._state.contextMenuActiveIndex]),o?_(function(){o.focus()},100,this):this._closeContextMenu()}}},{key:"handleClickOutside",value:function(e){var t=this;_(function(){var a=t._state,r=a.focusDragElem,n=a.focusMenuElem,o=e.waferComposedMap;o().get(r)||o().get(n)||t._closeContextMenu()},1,this)}},{key:"handleDrop",value:function(e){var t=this.getDragElem();if(e.stopPropagation(),t){var a=e.currentTarget;if("true"!==a.getAttribute("draggable"))return;a.previousElementSibling===t?(a.parentElement.insertBefore(a,t),this.didDrag({dragElem:a,dropElem:t})):(a.parentElement.insertBefore(t,a),this.didDrag({dragElem:t,dropElem:a}))}}},{key:"config",get:function(){var e=this._util,t=e.config;return{config:void 0===t?{}:t,elem:e.elem,id:e.id}}}]),t}(g);A.events={click:[["wafer-module-add","handleAdd"],["wafer-module-move-down","handleMoveDown"],["wafer-module-move-to-column","handleMoveToColumn"],["wafer-module-move-up","handleMoveUp"],["wafer-module-remove","handleRemove"]],drag:[["_self","handleDrag"]],dragend:[["_self","handleDragEnd"]],dragenter:[["_self","handleDragEnter"]],dragleave:[["_self","handleDragLeave"]],dragover:[["_self","handleDragOver"]],dragstart:[["_self","handleDragStart"]],drop:[["_self","handleDrop"]],focusin:[[D,"handleDragIndicatorFocusIn"]],mouseenter:[[D,"handleMouseEnter"]],mouseleave:[[D,"handleMouseleave"]]},t.default=A,e.exports=t.default},"./src/controller.js":function(e,t,a){"use strict";function r(){return c=o(a("./src/base.js"))}function n(){return u=a("./src/utils.js")}function o(e){return e&&e.__esModule?e:{default:e}}function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var c,u,f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},m=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),g=function e(t,a,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,a);if(void 0===n){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,a,r)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(r)},v=window.wafer,p=v.base,h=v.utils,y=h.bindEvent,_=h.convertNodeListToArray,E=h.fetchWithCache,b=h.findAncestor,w=h.getConfigFromJSONScriptNode,D=h.throttle,M=h.unbindEvent,A=window.wafer.controllers.WaferBaseController,C="wafer-module-drag-in-progress",O="wafer-module-drop-target",x="wafer-module-drop-target-with-selector",T="wafer-module-set-active",N="wafer-module-added",I="wafer-module-add-in-progress",k="wafer-module-error",L="wafer-module-with-config",B=document.body,S=void 0,P=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.root,o=void 0===a?document:a,i=e.selector,d=e.successClass,m=void 0===d?"wafer-module-complete":d;l(this,t);var g=w(document.getElementById("wafer-module-config")),v={};g.bodyErrorClass=g.bodyErrorClass||k;var h=g.bodyErrorClass,E=g.modulesAdded,M=void 0===E?[]:E,A=g.moveAriaMessage;M.forEach(function(e){v[e]=!0});var S=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{root:o,selector:i,props:{selector:i,successClass:m},WaferClass:(c||r()).default})),P=S;S._util=f({},S._util,{moduleConfig:g}),S._state=f({},S._state,{activeElem:null,dragElem:null,dropTargetElementConfigMap:new Map,idInstanceMapping:new Map,lastTargetIndex:0,modulesAddedMap:v,proxyElem:null}),S.handleBodyDragover=S.handleBodyDragover.bind(S),S.handleBodyDrop=S.handleBodyDrop.bind(S),S.handleDragEnd=S.handleDragEnd.bind(S),S.handleDragLeave=D(S.handleDragLeave.bind(S)),y(document.body,"dragover",S.handleBodyDragover,{passive:!1}),y(document.body,"drop",S.handleBodyDrop),y(document.body,"dragend",S.handleDragEnd,{passive:!1}),y(document.body,"dragleave",S.handleDragLeave,{passive:!1});var j=g.enableSnapshotOnLoad,R=void 0===j||j;return(c||r()).default.prototype.addInstanceToIdMap=function(){var e=P._state.idInstanceMapping,t=this._util.id;e.has(t)||e.set(t,[]);var a=P._state.modulesAddedMap;e.get(t).push(this),a[t]&&e.get(t).forEach(function(e){if(!e._destroyed){e._util.elem.classList.add(N)}})},(c||r()).default.prototype.setDragElem=function(e){P._state.dragElem=e},(c||r()).default.prototype.getDragElem=function(){return P._state.dragElem},(c||r()).default.prototype.handleAdd=function(){var e=P._state.activeElem,t=!1,a=this._util.elem,r=b(a,x);e&&!r||(t=!r,e=P.getActiveTarget(a,r));var o=b(e,L),i=b(e,O),l=this.config,s=l.config,d=l.id;if(!a.classList.contains(I)){a.classList.add(I);var c=i&&i.getElementsByClassName(L),m=0;if(o)m=_(o.parentNode.children).indexOf(o);else if(t)m=0;else{var g=c&&c.length||0;m=0===g?0:g+1}if(i){var y=P.getDropTargetConfig(i),E=f({},s,y);E.rank=m||0,this.focus(),P.handleInlineAddingModule(i,c,E.packageId||E.id||d,E.parentId||"",d,a,m,v,this).then(function(){var e=(0,(u||n()).getSnapshot)(E,{source:"add"});P.triggerAction(e)}).catch(function(e){B.classList.add(h),a.classList.remove(I),p.emitError({name:"WaferModule",elem:a,meta:{type:"addModuleActionFailed"},stack:e.stack||e.message})})}}},(c||r()).default.prototype.didDrag=function(){var e=P._state.dragElem;if(e){e.classList.remove(C);var t=P._state.elementInstances,a=t.get(e)||{},r=a.instance;if(r){var o=this.config.elem,i=b(o,O);if(i){var l=P.getDropTargetConfig(i),s=r.config.config,d=e.parentNode.children,c=_(d).indexOf(e),m=f({},s,l,{rank:c}),g=s.name,v=l.name,y=(0,(u||n()).getSnapshot)(m);if(g&&v&&A){var E=A.replace("[NAME]",g).replace("[DROP_NAME]",v).replace("[DROP_ITEMS_COUNT]",d.length).replace("[RANK]",c+1);p.liveAriaRegion.innerHTML=E}this.focus(),P.triggerAction(y).catch(function(e){B.classList.add(h),p.emitError({name:"WaferModule",elem:o,meta:{type:"dragdropModuleActionFailed"},stack:e.stack||e.message})}),p.emitWaferEvent("wafer:module:drop:complete",{elem:e,meta:{config:f({},s,l)}})}P._state.dragElem=null}}},(c||r()).default.prototype.didRemove=function(e){var t=P._state.idInstanceMapping,a=this._util,r=a.config,o=a.elem,i=a.id;if(v[i]&&t.has(i))for(var l=P._state.activeElem,s=t.get(i),d=s.length,c=b(l,L),f=d-1;f>=0;f--){var m=s[f];if(m._destroyed)t.get(i).splice(f,1);else{var g=m._util,y=g.elem,_=g.removeSelfOnDelete;if(_&&y!==e){if(c===y&&(P._state.activeElem=y.previousSibling,!P._state.activeElem)){var E=y.parentNode,w=E.getElementsByClassName(T);P._state.activeElem=w[w.length-1]}p.destroy(y),y.parentNode.removeChild(y),t.get(i).splice(f,1)}y.classList.remove(N)}}var D=r.parentId,M=void 0;if(v[i]=!1,D){var A=(0,(u||n()).getSnapshot)(r,{source:"delete"});M=P.triggerAction(A)}else M=P.triggerAction({mainData:{removedPackages:[r.packageId||r.id||i]}});M.catch(function(e){B.classList.add(h),p.emitError({name:"WaferModule",elem:o,meta:{type:"removeModuleActionFailed"},stack:e.stack||e.message})}),r.removeMessage&&(p.liveAriaRegion.innerHTML=r.removeMessage),p.emitWaferEvent("wafer:module:deleted",{elem:o,meta:{config:{id:r.id||i}}})},(c||r()).default.prototype._handleMoveUp=function(){var e=this._util.elem,t=e.previousElementSibling;if(t){var a=this.config.config,r=a;e.parentNode.insertBefore(e,t);var o=(0,(u||n()).getSnapshot)(r),i=b(e,O),l=_(i.getElementsByClassName(L)).filter(function(e){return e.getAttribute("draggable")}),s=a.name,d=P.getDropTargetConfig(i),c=d.name,f=l.indexOf(e);if(s&&c&&A){var m=A.replace("[NAME]",s).replace("[DROP_NAME]",c).replace("[DROP_ITEMS_COUNT]",l.length).replace("[RANK]",f+1);p.liveAriaRegion.innerHTML=m}this.focus(),P.triggerAction(o).catch(function(t){B.classList.add(h),p.emitError({name:"WaferModule",elem:e,meta:{type:"moveUpFailed"},stack:t.stack||t.message})}),p.emitWaferEvent("wafer:module:moveup:complete",{elem:e,meta:{config:a}})}},(c||r()).default.prototype._handleMoveDown=function(){var e=this._util.elem,t=b(e,O),a=_(t.getElementsByClassName(L)).filter(function(e){return e.getAttribute("draggable")}),r=a.indexOf(e),o=this.config.config,i=o;e.parentNode.insertBefore(a[r+1],e);var l=(0,(u||n()).getSnapshot)(i),s=_(t.getElementsByClassName(L)),d=o.name,c=P.getDropTargetConfig(t),f=c.name,m=s.indexOf(e);if(d&&f&&A){var g=A.replace("[NAME]",d).replace("[DROP_NAME]",f).replace("[DROP_ITEMS_COUNT]",s.length).replace("[RANK]",m+1);p.liveAriaRegion.innerHTML=g}this.focus(),P.triggerAction(l).catch(function(t){B.classList.add(h),p.emitError({name:"WaferModule",elem:e,meta:{type:"moveDownFailed"},stack:t.stack||t.message})}),p.emitWaferEvent("wafer:module:movedown:complete",{elem:e,meta:{config:o}})},(c||r()).default.prototype._handleMoveToColumn=function(e){var t=e.target,a=this._util.elem,r=this.config.config,o=r,i=t.getAttribute("data-index");i=parseInt(i,10)||1;var l=document.getElementsByClassName(O)[i-1],s=l.getElementsByClassName(L)[0]||l.children[0];s&&l.insertBefore(a,s);var d=(0,(u||n()).getSnapshot)(o),c=b(a,O),f=_(c.getElementsByClassName(L)).filter(function(e){return e.getAttribute("draggable")}),m=r.name,g=P.getDropTargetConfig(c),v=g.name,y=f.indexOf(a);if(m&&v&&A){var E=A.replace("[NAME]",m).replace("[DROP_NAME]",v).replace("[DROP_ITEMS_COUNT]",f.length).replace("[RANK]",y+1);p.liveAriaRegion.innerHTML=E}this.focus(),P.triggerAction(d).catch(function(e){B.classList.add(h),p.emitError({name:"WaferModule",elem:a,meta:{type:"moveUpFailed"},stack:e.stack||e.message})}),p.emitWaferEvent("wafer:module:moveacrosscolumns:complete",{elem:a,meta:{config:r}})},S.sync(),R&&setTimeout(function(){var e=(0,(u||n()).getSnapshot)();e&&e.mainData.packageData.length&&S.triggerAction(e).catch(function(e){})},100),S}return d(t,e),m(t,[{key:"handleInlineAddingModule",value:function(e,t,a,r,n,o,i,l,s){var d=this._util.moduleConfig,c=void 0===d?{}:d,u=c.addFetchUrl;return E((void 0===u?"/?p_id=MODULE_ID&parent_id=PARENT_ID":u).replace(/MODULE_ID/,a).replace(/PARENT_ID/,r),{timeout:1e4,cacheStrategy:"cacheFirst"}).then(function(r){var d=r.html,c=document.createElement("div"),u=t.length&&t[i];l[n]=!0,o.classList.remove(I),c.innerHTML=d;var f=c.children[0];if(u)e.insertBefore(f,t[i]);else{var m=e.children,g=i?m[m.length-1]:m[0];e.insertBefore(f,g)}if(p.sync(e),s){var v=s.config.config,h=void 0===v?{}:v,y=h.addMessage;s.focus(),y&&(p.liveAriaRegion.innerHTML=y)}p.emitWaferEvent("wafer:module:saved",{elem:o,meta:{config:{id:a}}})}).catch(function(e){var t=c.bodyErrorClass;B.classList.add(t),l[n]=!1,o.classList.remove(I),p.emitError({name:"WaferModule",elem:o,meta:{type:"addModuleActionFailed"},stack:e.stack||e.message})})}},{key:"getActiveTarget",value:function(e,t){var a=_(document.getElementsByClassName(O));if(!a.length)return null;var r=t&&t.getAttribute("data-wf-module-drop-target");if(r){var n=document.querySelector(r);if(n)return n}return this._state.lastTargetIndex>=a.length&&(this._state.lastTargetIndex=0),a[this._state.lastTargetIndex++]}},{key:"handleEvent",value:function(e,a,r){if(g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"handleEvent",this).call(this,e,a,r),r&&"click"===r.type){var n=r.target;n.className&&n.classList.contains(T)&&(this._state.activeElem=n)}}},{key:"triggerAction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=(t.critical,e.meta),r=void 0===a?{}:a,n=e.mainData,o=this._util.moduleConfig,l=void 0===o?{}:o;return l.actionHost?this.getCrumb().then(function(e){if(!e)throw new Error("crumb not found");var t=l.actionHost,a=l.actionVersion,o=void 0===a?"v2":a,s=l.appId,d=l.experienceId,c=l.currentContainers,u=void 0===c?{}:c,m=l.propertyId,g=i({},m,f({selectedContainer:d,containers:[f({id:d},n)]},r,{currentContainers:u}));return E(t+"api/"+o+"/preferences/declared/common?appId="+s,{cache:0,clientHeaders:{Crumb:e},credentials:"include",method:"PUT",body:JSON.stringify(g),mode:"cors"})}):Promise.resolve()}},{key:"getDropTargetConfig",value:function(e){var t=this._state.dropTargetElementConfigMap,a=t.get(e);if(!a)try{a=JSON.parse(e.getAttribute("data-wf-module-drop-target-config")),t.set(e,a)}catch(e){}return a}},{key:"getCrumb",value:function(){var e=this._util.moduleConfig,t=void 0===e?{}:e,a=t.crumb||S;if(a)return Promise.resolve(a);var r=t.actionHost,n=t.appId;return E(r+"api/v1/auth/crumb?appId="+n,{cache:0,credentials:"include",mode:"cors"}).then(function(e){if(!(S=e.crumb))throw new Error("crumb not found");return S})}},{key:"handleBodyDragover",value:function(e){var t=e.target;if(t.classList.contains(O)&&(e.preventDefault(),!this._state.proxyElem)){var a=document.createElement("div"),r=_(t.getElementsByClassName(L)),n=r.length;if(a.style.pointerEvents="none",a.classList.add("wafer-module-drop-proxy"),this._state.proxyElem=a,n){var o=r[n-1];t.insertBefore(a,o.nextSibling)}else t.insertBefore(a,t.children[0])}}},{key:"handleBodyDrop",value:function(e){var t=this._state.dragElem;if(t){var a=this._util.moduleConfig,r=void 0===a?{}:a,o=r.bodyErrorClass,i=r.moveAriaMessage,l=e.target;if(l.classList.contains(O)){var s=this._state,d=s.elementInstances,c=s.dropTargetElementConfigMap,m=d.get(t)||{},g=m.instance,v=c.get(l);if(!v)try{v=JSON.parse(l.getAttribute("data-wf-module-drop-target-config")),c.set(l,v)}catch(e){}var h=_(l.getElementsByClassName(L)),y=h.length,E=void 0;if(y){var b=h[y-1];E=y,l.insertBefore(t,b.nextSibling)}else E=0,l.insertBefore(t,l.children[0]);var w=g.config.config,D=f({},w,v),M=(0,(u||n()).getSnapshot)(D);this.triggerAction(M).catch(function(e){B.classList.add(o),p.emitError({name:"WaferModule",elem:t,meta:{type:"actionFailed"},stack:e.stack||e.message})});var A=w.name,C=v,x=C.name;if(A&&x&&i){var T=i.replace("[NAME]",A).replace("[DROP_NAME]",x).replace("[DROP_ITEMS_COUNT]",y).replace("[RANK]",E+1);p.liveAriaRegion.innerHTML=T}p.emitWaferEvent("wafer:module:drop:complete",{elem:t,meta:{config:D}})}}}},{key:"handleDragLeave",value:function(e){var t=e.target,a=this._state.proxyElem;a&&t.classList.contains(O)&&(a.parentNode.removeChild(a),this._state.proxyElem=null)}},{key:"handleDragEnd",value:function(e){var t=this._state.proxyElem;if(t){var a=t.parentNode;a&&a.removeChild(t),this._state.proxyElem=null}}},{key:"destroy",value:function(e){g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this,e),e||(M(document.body,"dragover",this.handleBodyDragover,{passive:!1}),M(document.body,"drop",this.handleBodyDrop),M(document.body,"dragend",this.handleDragEnd,{passive:!1}),M(document.body,"dragleave",this.handleDragLeave,{passive:!1}))}}]),t}(A);t.default=P,e.exports=t.default},"./src/entry.js":function(e,t,a){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n;t.default=new((n||function(){return n=r(a("./src/controller.js"))}()).default)({selector:"wafer-module"}),e.exports=t.default},"./src/utils.js":function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=window.wafer.utils,n=r.convertNodeListToArray,o=r.getWaferInstanceForElem,i={},l=n(document.getElementsByClassName("wafer-module-drop-target")),s=l.map(function(e){var t=e.getAttribute("data-wf-module-drop-target-config");try{t=JSON.parse(t)}catch(e){}return t=t||{},{elem:e,regionId:t.regionId}});t.getSnapshot=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=t.source,r=[],l={},d=e.packageId,c="delete"===a;return d&&(i[d]=!c),s.forEach(function(t){var s=t.elem,d=t.regionId;n(s.getElementsByClassName("wafer-module")).forEach(function(t,n){var s=o(t,"wafer-module"),u=s.instance,f=void 0===u?{}:u,m=f.config||{},g=m.config,v=g.id===e.id;if(!c||!v){var p=g||{},h=p.meta,y=p.id,_=p.instanceId,E=p.parentId,b=p.pin,w=void 0!==b&&b,D=g||{},M=D.packageId;M=M||y;var A={id:M,pin:i[M]||w,rank:n,regionId:d};v&&E&&"add"===a&&(h.createdAt=h.createdAt||+Date.now(),l[E]=l[E]||[],l[E].push(Object.assign({instanceId:_},h))),_&&(A.instanceId=_),M&&r.push(A)}})}),{meta:l,mainData:{packageData:r}}}}})});